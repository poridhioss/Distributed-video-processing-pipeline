apiVersion: v1
kind: ConfigMap
metadata:
  name: postgres-init-script
  namespace: video-processing
data:
  schema.sql: |
    -- Video Processing Database Schema
    -- This schema tracks video processing status and metadata

    -- Create ENUM type for video processing status
    CREATE TYPE video_status AS ENUM ('uploaded', 'processing', 'completed', 'failed');

    -- Videos table: tracks all uploaded videos and their processing status
    CREATE TABLE IF NOT EXISTS videos (
        id UUID PRIMARY KEY,
        original_name VARCHAR(255) NOT NULL,
        file_size BIGINT NOT NULL,
        mime_type VARCHAR(100) NOT NULL,
        video_duration FLOAT,
        minio_key VARCHAR(500) NOT NULL,
        status video_status NOT NULL DEFAULT 'uploaded',
        thumbnail_count INTEGER,
        sprite_sheet_path VARCHAR(500),
        metadata_path VARCHAR(500),
        error_message TEXT,
        created_at TIMESTAMP NOT NULL DEFAULT NOW(),
        updated_at TIMESTAMP NOT NULL DEFAULT NOW()
    );

    -- Create index on status for faster queries
    CREATE INDEX IF NOT EXISTS idx_videos_status ON videos(status);

    -- Create index on created_at for sorting
    CREATE INDEX IF NOT EXISTS idx_videos_created_at ON videos(created_at DESC);

    -- Create function to automatically update updated_at timestamp
    CREATE OR REPLACE FUNCTION update_updated_at_column()
    RETURNS TRIGGER AS $$
    BEGIN
        NEW.updated_at = NOW();
        RETURN NEW;
    END;
    $$ language 'plpgsql';

    -- Create trigger to auto-update updated_at
    CREATE TRIGGER update_videos_updated_at
        BEFORE UPDATE ON videos
        FOR EACH ROW
        EXECUTE FUNCTION update_updated_at_column();

    -- Insert sample comment for documentation
    COMMENT ON TABLE videos IS 'Stores video metadata and processing status';
    COMMENT ON COLUMN videos.id IS 'Unique video identifier (UUID)';
    COMMENT ON COLUMN videos.status IS 'Processing status: uploaded, processing, completed, failed';
    COMMENT ON COLUMN videos.video_duration IS 'Video duration in seconds (extracted by FFprobe)';
    COMMENT ON COLUMN videos.sprite_sheet_path IS 'MinIO path to sprite sheet (e.g., sprites/{videoId}/sprite_0.jpg)';
    COMMENT ON COLUMN videos.metadata_path IS 'MinIO path to metadata.json';
